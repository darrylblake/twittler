<!DOCTYPE html>
<html>
    <head>
        <script src="jquery.js"></script>
        <script src="data_generator.js"></script>
        <script src="jquery.timeago.js"></script>
    </head>
    <body>
        <section id="tweets"></section>
        <script>
            $(document).ready(function(){
                var avatars = {
                    'douglascalhoun': 'https://media.licdn.com/media/p/4/000/149/320/1c2f421.jpg',
                    'mracus': 'https://media.licdn.com/media/p/8/005/05d/0b0/2645c4a.jpg',
                }

                // Needed to clear the intervals inside the closures 
                var checkTweetsInterval;

                function displayStream(stream) {
                    console.log(stream);
                    $('#tweets').html('');

                    function displayNewTweets(stream, index) {    
                        while(index <= stream.length -1){
                            var tweet = stream[index];
                            var time = '<time class="timeago" datetime="' + tweet.created_at.toISOString() + '">' + tweet.created_at.toLocaleDateString() + '</time>';
                            var user = '<a class="user" href="#" data-user="' + tweet.user + '">@' + tweet.user + '</a>';
                            var $tweet = $('<div></div>');
                            $tweet.html(user + ': ' + tweet.message + ' ' + time);
                            $tweet.prependTo($('#tweets'));
                            index++;
                            $(".timeago").timeago();
                        }
                        return index;
                    }
                    // Loads the pregenerated posts
                    var current_length = displayNewTweets(stream, 0);

                    checkTweetsInterval = setInterval(function(){
                        // If there are new tweets             
                        if (stream.length > current_length) {
                            current_length = displayNewTweets(stream, current_length);
                        }
                    }, 250);
                }

                displayStream(streams.home);

                $('body').on('click', '.user', function(){
                    clearInterval(checkTweetsInterval);
                    displayStream(streams.users[$(this).data('user')]);
                });
                
            });
        </script>
    </body>
</html>
